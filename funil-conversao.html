<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WEKOTA â€” Fluxo de ConversÃ£o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --navy: #0F2B3C;
      --navy-deep: #091D2A;
      --teal: #4ECBA5;
      --slate: #8FA3B0;
      --white: #FFFFFF;
      --text: #C8D6DE;
      --divider: rgba(255,255,255,0.06);
      --card-bg: rgba(255,255,255,0.035);
      --card-border: rgba(255,255,255,0.08);
      --input-bg: rgba(255,255,255,0.05);
      --input-border: rgba(255,255,255,0.12);
      --whatsapp: #25D366;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--navy-deep);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .funnel-wrap {
      max-width: 480px;
      margin: 0 auto;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .funnel-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 2rem;
    }
    .funnel-logo {
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-weight: 800; font-size: 1.2rem; color: var(--white);
    }
    .funnel-logo span { color: var(--teal); }
    .funnel-close {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      color: var(--slate);
      cursor: pointer;
    }

    .progress-wrap { margin-bottom: 2rem; display: none; }
    .progress-wrap.visible { display: block; }
    .progress-steps { display: flex; gap: 6px; margin-bottom: 0.5rem; }
    .progress-dot { flex: 1; height: 3px; background: var(--divider); border-radius: 3px; }
    .progress-dot.active { background: var(--teal); }
    .progress-dot.done { background: var(--teal); opacity: 0.5; }
    .progress-label { font-size: 0.72rem; color: var(--slate); font-weight: 600; text-transform: uppercase; }

    .screen { display: none; animation: screenIn 0.4s ease both; }
    .screen.active { display: block; }
    @keyframes screenIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .screen-title { font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.65rem; font-weight: 800; color: var(--white); margin-bottom: 0.6rem; }
    .screen-sub { font-size: 0.95rem; color: var(--slate); line-height: 1.6; margin-bottom: 1.75rem; }

    .split-choices { display: flex; flex-direction: column; gap: 12px; }
    .split-btn {
      position: relative; padding: 1.35rem; border-radius: 16px; border: none; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 1rem;
    }
    .split-btn-primary { background: var(--teal); color: var(--navy-deep); }
    .split-btn-secondary { background: var(--card-bg); border: 1px solid var(--card-border); color: var(--white); }
    .split-icon { font-size: 1.5rem; }
    .split-text h3 { font-size: 1.05rem; font-weight: 700; margin-bottom: 2px; }
    .split-text p { font-size: 0.82rem; opacity: 0.8; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--slate); margin-bottom: 0.45rem; text-transform: uppercase; }
    .form-input, .form-select {
      width: 100%; padding: 0.9rem; background: var(--input-bg); border: 1.5px solid var(--input-border); border-radius: 12px; color: var(--white); font-size: 1rem; outline: none;
    }

    .product-card, .dur-card, .pay-method {
      padding: 1rem; background: var(--card-bg); border: 2px solid var(--card-border); border-radius: 14px; cursor: pointer; margin-bottom: 10px;
    }
    .selected { border-color: var(--teal); background: rgba(78, 203, 165, 0.05); }

    .btn-primary {
      width: 100%; padding: 1rem; background: var(--teal); color: var(--navy-deep); font-weight: 700; border: none; border-radius: 14px; cursor: pointer; font-size: 1rem; margin-top: 1rem;
    }
    .btn-secondary {
      width: 100%; padding: 0.85rem; background: transparent; color: var(--slate); border: 1px solid var(--card-border); border-radius: 12px; cursor: pointer; margin-top: 0.6rem;
    }

    .contract-summary { background: var(--card-bg); padding: 1.5rem; border-radius: 16px; margin: 1.5rem 0; font-size: 0.9rem; }
    .cs-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--divider); }
    .cs-value { font-weight: 600; color: var(--white); }
    .highlight-val { color: var(--teal); }

    .success-icon { width: 60px; height: 60px; background: var(--teal); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 1.5rem; color: var(--navy-deep); }
  </style>
</head>
<body>

<div class="funnel-wrap">
  <div class="funnel-header">
    <div class="funnel-logo">WEKO<span>TA</span></div>
    <div class="funnel-close" onclick="location.href='/'">âœ•</div>
  </div>

  <div class="progress-wrap" id="progressWrap">
    <div class="progress-steps">
      <div class="progress-dot" id="dot1"></div>
      <div class="progress-dot" id="dot2"></div>
      <div class="progress-dot" id="dot3"></div>
      <div class="progress-dot" id="dot4"></div>
      <div class="progress-dot" id="dot5"></div>
    </div>
    <div class="progress-label" id="progressLabel">Passo 1 de 5</div>
  </div>

  <!-- SCREEN SPLIT -->
  <div class="screen active" id="screen-split">
    <div class="screen-title">Pronto para garantir o seu iPhone 17 Pro Max?</div>
    <div class="screen-sub">Junte-se ao grupo exclusivo WEKOTA.</div>
    <div class="split-choices">
      <button class="split-btn split-btn-primary" onclick="window.goTo('step1')">
        <div class="split-icon">ðŸš€</div>
        <div class="split-text"><h3>Quero garantir o meu</h3><p>InscriÃ§Ã£o rÃ¡pida e segura.</p></div>
      </button>
      <button class="split-btn split-btn-secondary" onclick="window.goTo('doubt')">
        <div class="split-icon">ðŸ’¬</div>
        <div class="split-text"><h3>Tenho dÃºvidas primeiro</h3><p>Fale com a nossa equipa.</p></div>
      </button>
    </div>
  </div>

  <!-- SCREEN STEP 1 -->
  <div class="screen" id="screen-step1">
    <div class="screen-title">Vamos comeÃ§ar ðŸ‘‹</div>
    <div class="form-group">
      <label class="form-label">Nome completo</label>
      <input class="form-input" id="input-name" type="text" placeholder="Seu nome" />
    </div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input class="form-input" id="input-email" type="email" placeholder="seu@email.com" />
    </div>
    <button class="btn-primary" id="btn-next-1">Continuar</button>
  </div>

  <!-- SCREEN STEP 2 -->
  <div class="screen" id="screen-step2">
    <div class="screen-title">Escolha o seu plano</div>
    <div class="dur-card" onclick="window.setPlan(12, this)">
      <div style="font-size: 1.2rem; font-weight: 700;">12 Meses</div>
      <div style="color: var(--teal);">â‚¬149/mÃªs</div>
    </div>
    <div class="dur-card selected" onclick="window.setPlan(24, this)">
      <div style="font-size: 1.2rem; font-weight: 700;">24 Meses</div>
      <div style="color: var(--teal);">â‚¬75/mÃªs</div>
    </div>
    <button class="btn-primary" onclick="window.goTo('step3')">Continuar</button>
  </div>

  <!-- SCREEN STEP 3 -->
  <div class="screen" id="screen-step3">
    <div class="screen-title">VerificaÃ§Ã£o</div>
    <div class="screen-sub">Carregue uma foto do seu documento para prosseguir.</div>
    <div class="product-card" style="text-align: center; border-style: dashed;">
      Clique para carregar documento
    </div>
    <button class="btn-primary" onclick="window.goTo('step4')">Continuar</button>
  </div>

  <!-- SCREEN STEP 4 -->
  <div class="screen" id="screen-step4">
    <div class="screen-title">Resumo do Contrato</div>
    <div class="contract-summary">
      <div class="cs-row"><span>Produto</span><span class="cs-value">iPhone 17 Pro Max</span></div>
      <div class="cs-row"><span>Plano</span><span class="cs-value" id="summary-dur">24 meses</span></div>
      <div class="cs-row"><span>Valor Mensal</span><span class="cs-value highlight-val" id="summary-price">â‚¬75,00</span></div>
    </div>
    <button class="btn-primary" onclick="window.goTo('step5')">Aceitar e Pagar</button>
  </div>

  <!-- SCREEN STEP 5 -->
  <div class="screen" id="screen-step5">
    <div class="screen-title">Pagamento</div>
    <div class="pay-method selected" onclick="window.selectMethod('CartÃ£o', this)">
      <strong>CartÃ£o de CrÃ©dito/DÃ©bito</strong>
      <p style="font-size: 0.8rem; color: var(--slate);">Processamento via Stripe</p>
    </div>
    <div class="pay-method" onclick="window.selectMethod('MBWAY', this)">
      <strong>MB WAY / Outros</strong>
    </div>
    <button class="btn-primary" id="btn-pay">Confirmar Pagamento</button>
  </div>

  <!-- SUCCESS -->
  <div class="screen" id="screen-success">
    <div class="success-icon">âœ“</div>
    <div class="screen-title" style="text-align: center;">Tudo Pronto!</div>
    <div class="screen-sub" style="text-align: center;">O seu lugar no grupo estÃ¡ garantido. Enviamos os detalhes para o seu email.</div>
    <button class="btn-primary" onclick="location.href='/'">Voltar ao InÃ­cio</button>
  </div>

  <!-- DOUBT -->
  <div class="screen" id="screen-doubt">
    <div class="screen-title">DÃºvidas?</div>
    <div class="screen-sub">Fale diretamente com o nosso suporte comercial.</div>
    <button class="btn-primary" style="background: var(--whatsapp);" onclick="window.open('https://wa.me/34671941267')">WhatsApp Suporte</button>
    <button class="btn-secondary" onclick="window.goTo('split')">Voltar</button>
  </div>

</div>

<script type="module">
  import { supabase } from './supabaseClient.js';
  import { loadStripe } from 'https://cdn.jsdelivr.net/npm/@stripe/stripe-js/+esm';

  const stripePromise = loadStripe('pk_live_51T4kqUEGWHer1k6eO5Cd78vy9ybpe6OyJPoxrtktomzhu1RQvdoFlPkrLfxMKYoBk2CdmgkI3WRrKZ6vh8XgqQ2h00efKSW7Mn');

  let currentLeadId = null;
  let selectedPriceId = 'price_1QxyAtUEGWHer1k6eYvVrPk'; // 24 meses
  let selectedMethod = 'CartÃ£o';

  window.goTo = (screenId) => {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + screenId).classList.add('active');
    
    const pw = document.getElementById('progressWrap');
    if (screenId.startsWith('step')) {
      pw.classList.add('visible');
      const step = screenId.replace('step', '');
      document.getElementById('progressLabel').innerText = `Passo ${step} de 5`;
      for(let i=1; i<=5; i++) {
        const dot = document.getElementById('dot'+i);
        dot.className = 'progress-dot';
        if (i < step) dot.classList.add('done');
        if (i == step) dot.classList.add('active');
      }
    } else {
      pw.classList.remove('visible');
    }
    window.scrollTo(0,0);
  };

  window.setPlan = (months, el) => {
    document.querySelectorAll('.dur-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    if(months === 12) {
      selectedPriceId = 'price_1Qxy9ZUEGWHer1k6eIdkhNm';
      document.getElementById('summary-dur').innerText = '12 meses';
      document.getElementById('summary-price').innerText = 'â‚¬149,00';
    } else {
      selectedPriceId = 'price_1QxyAtUEGWHer1k6eYvVrPk';
      document.getElementById('summary-dur').innerText = '24 meses';
      document.getElementById('summary-price').innerText = 'â‚¬75,00';
    }
  };

  window.selectMethod = (method, el) => {
    document.querySelectorAll('.pay-method').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedMethod = method;
  };

  document.getElementById('btn-next-1').addEventListener('click', async () => {
    const name = document.getElementById('input-name').value;
    const email = document.getElementById('input-email').value;
    if(!name || !email) return alert('Preencha nome e email');

    try {
      const { data, error } = await supabase.from('leads').insert([{ name, email, status: 'started' }]).select();
      if(!error && data) currentLeadId = data[0].id;
    } catch(e) {}
    window.goTo('step2');
  });

  document.getElementById('btn-pay').addEventListener('click', async () => {
    if (selectedMethod === 'CartÃ£o') {
      const btn = document.getElementById('btn-pay');
      btn.innerText = 'A processar...';
      btn.disabled = true;

      try {
        const { data, error } = await supabase.functions.invoke('stripe-payments', {
          body: {
            action: 'create-checkout-session',
            lead_id: currentLeadId,
            price_id: selectedPriceId,
            success_url: window.location.origin + '/funil-conversao.html?status=success',
            cancel_url: window.location.origin + '/funil-conversao.html?status=cancel'
          }
        });
        if (data?.url) window.location.href = data.url;
        else throw new Error();
      } catch(e) {
        alert('Erro ao conectar com Stripe. Tente novamente.');
        btn.innerText = 'Confirmar Pagamento';
        btn.disabled = false;
      }
    } else {
      window.goTo('success');
    }
  });

  if(new URLSearchParams(window.location.search).get('status') === 'success') {
    window.goTo('success');
  }
</script>

</body>
</html>
